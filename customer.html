<!DOCTYPE html>
<html>
<head>
<title>Customer Detail</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, onValue, push, set, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqD1fUrRi__yIQJlTezAawZ-4xYNtIGyQ",
  authDomain: "shop-credit-saas-d3dfb.firebaseapp.com",
  databaseURL: "https://shop-credit-saas-d3dfb-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shop-credit-saas-d3dfb",
  storageBucket: "shop-credit-saas-d3dfb.firebasestorage.app",
  messagingSenderId: "154575017871",
  appId: "1:154575017871:web:ea1944700ed3957c669dfa"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser;
let customerId;
let customerData;

customerId = new URLSearchParams(window.location.search).get("id");

onAuthStateChanged(auth,(user)=>{
  if(!user) window.location="login.html";
  else{
    currentUser=user;
    loadCustomer();
    loadTransactions();
  }
});

function loadCustomer(){
  const customerRef=ref(db,"customers/"+currentUser.uid+"/"+customerId);
  onValue(customerRef,(snap)=>{
    customerData=snap.val();
    document.getElementById("info").innerHTML=
      `<b>${customerData.name}</b><br>
       Phone: ${customerData.phone}<br>
       Total Due: ₹${customerData.total_due}<br>
       Total Paid: ₹${customerData.total_paid}`;
  });
}

window.addCredit=function(){
  const amount=parseFloat(document.getElementById("amount").value);

  push(ref(db,"transactions/"+currentUser.uid+"/"+customerId),{
    type:"credit",
    amount,
    date:new Date().toLocaleString()
  });

  update(ref(db,"customers/"+currentUser.uid+"/"+customerId),{
    total_due: customerData.total_due + amount
  });

  document.getElementById("amount").value="";
}

window.addPayment=function(){
  const amount=parseFloat(document.getElementById("amount").value);

  push(ref(db,"transactions/"+currentUser.uid+"/"+customerId),{
    type:"payment",
    amount,
    date:new Date().toLocaleString()
  });

  update(ref(db,"customers/"+currentUser.uid+"/"+customerId),{
    total_due: customerData.total_due - amount,
    total_paid: customerData.total_paid + amount
  });

  document.getElementById("amount").value="";
}

function loadTransactions(){
  const transRef=ref(db,"transactions/"+currentUser.uid+"/"+customerId);

  onValue(transRef,(snapshot)=>{
    let html="";
    snapshot.forEach(child=>{
      const t=child.val();
      html+=`<div>
        ${t.date} - ${t.type} ₹${t.amount}
      </div>`;
    });
    document.getElementById("history").innerHTML=html;
  });
}
</script>
</head>
<body>

<div id="info"></div>

<hr>
<input id="amount" placeholder="Amount">
<button onclick="addCredit()">Add Credit</button>
<button onclick="addPayment()">Add Payment</button>

<hr>
<h3>Transaction History</h3>
<div id="history"></div>

</body>
</html>
